# Emissary

[Emissary Ingress](https://github.com/datawire/ambassador) - Emissary Ingress is a self-service, comprehensive API gateway that is Kubernetes-native and built on [Envoy Proxy](https://www.envoyproxy.io/).

## TL;DR;

```console
$ helm repo add emissary-ingress https://app.getambassador.io
$ helm repo update
$ helm install emissary-ingress --devel emissary-ingress/emissary-ingress -n ambassador --version=8.12.2
```

## Introduction

This chart deploys Emissary Ingress on a [Kubernetes](http://kubernetes.io) cluster using the [Helm](https://helm.sh) package manager.

This chart is used to install the 2.0 release line of Emissary Ingress. 

Versions in the older 1.0 release line of Emissary Ingress and Ambassador Edge Stack share a
single chart that can be found in this repository under the branch for the specific release, e.g.
[the release/v1.14 branch] for the latest 1.14 chart, [release/v1.13] for 1.13, and so on.

> Note that for 1.0 releases, the `enableAES` helm value is used to control installing Edge Stack or
  Emissary Ingress.

As of version 2.0, Emissary Ingress and Ambassador Edge Stack have separate charts. The helm chart
for Ambassador Edge Stack 2.0 lives in the [Ambassador Edge Stack chart repository].

See the [Ambassador Edge Stack FAQ] for more information about the differences between Emissary
Ingress and Ambassador Edge Stack.

[the release/v1.14 branch]: https://github.com/datawire/emissary/tree/release/v1.14/charts/ambassador 
[release/v1.13]: https://github.com/datawire/emissary/tree/release/v1.13/charts/ambassador 
[Ambassador Edge Stack chart repository]: https://github.com/datawire/edge-stack/tree/main/charts/edge-stack
[Ambassador Edge Stack FAQ]: https://www.getambassador.io/docs/edge-stack/latest/about/faq/#whats-the-difference-between-ossproductname-and-aesproductname

## Prerequisites

- Kubernetes v1.11+

## Installing the Chart

To install the chart with the release name `emissary-ingress`:

```console
$ helm install emissary-ingress --devel emissary-ingress/emissary-ingress -n ambassador --version=8.12.2
```

The command deploys Emissary Ingress on the Kubernetes cluster in the default configuration. The [configuration](#configuration) section lists the parameters that can be configured during installation.

> **Tip**: List all releases using `helm list`

## Uninstalling the Chart

To uninstall/delete the `emissary-ingress`:

```console
$ helm delete emissary-ingress -n ambassador
```

The command removes all the Kubernetes components associated with the chart and deletes the release.

## Changelog

Notable chart changes are listed in the [CHANGELOG](./CHANGELOG.md)

## Configuration

The following table lists the configurable parameters of the `emissary-ingress` chart and their default values.

|                Parameter                |                                                                                                                                                 Description                                                                                                                                                  |                                                                                                                                                  Default                                                                                                                                                  |
|-----------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| nameOverride                            | Override the generated chart name. Defaults to .Chart.Name.                                                                                                                                                                                                                                                  | <code>''</code>                                                                                                                                                                                                                                                                                           |
| fullnameOverride                        | Override the generated release name. Defaults to .Release.Name.                                                                                                                                                                                                                                              | <code>''</code>                                                                                                                                                                                                                                                                                           |
| namespaceOverride                       | Override the generated release namespace. Defaults to .Release.Namespace.                                                                                                                                                                                                                                    | <code>''</code>                                                                                                                                                                                                                                                                                           |
| replicaCount                            | Number of Ambassador replicas                                                                                                                                                                                                                                                                                | <code>3</code>                                                                                                                                                                                                                                                                                            |
| daemonSet                               | If true, Create a DaemonSet. By default Deployment controller will be created                                                                                                                                                                                                                                | <code>false</code>                                                                                                                                                                                                                                                                                        |
| barePod                                 | If true, Create a bare Pod instead of a Deployment or DaemonSet; for test purposes.                                                                                                                                                                                                                          | <code>false</code>                                                                                                                                                                                                                                                                                        |
| test.enabled                            | If true, Create test Pod to verify the Ambassador service works correctly (Only created on helm test)                                                                                                                                                                                                        | <code>false</code>                                                                                                                                                                                                                                                                                        |
| test.image                              | Image to use for the test Pod                                                                                                                                                                                                                                                                                | <code>busybox</code>                                                                                                                                                                                                                                                                                      |
| canary.enabled                          | Creates a Canary deployment and service using the following canary settings. Other settings inherited from main deployment                                                                                                                                                                                   | <code>false</code>                                                                                                                                                                                                                                                                                        |
| canary.mixPods                          | When true allows for requests to the main ambassador to hit either the pods from the main deployment or the canary deployment. Requests to the canary service will still only hit the canary pods                                                                                                            | <code>false</code>                                                                                                                                                                                                                                                                                        |
| canary.replicaCount                     | Similar to 'replicaCount', but controls the number of pods for the Canary deployment. 0 by default                                                                                                                                                                                                           | <code>0</code>                                                                                                                                                                                                                                                                                            |
| canary.image.repository                 | Controlls the image repository for the canary deployment.                                                                                                                                                                                                                                                    | <code>''</code>                                                                                                                                                                                                                                                                                           |
| canary.image.tag                        | Controlls the tag for the canary deployments image.repository. Uses the repository from the main deployment if the canay.image.repository is not set.                                                                                                                                                        | <code>''</code>                                                                                                                                                                                                                                                                                           |
| ingressClassResource.enabled            |                                                                                                                                                                                                                                                                                                              | <code>true</code>                                                                                                                                                                                                                                                                                         |
| ingressClassResource.name               |                                                                                                                                                                                                                                                                                                              | <code>ambassador</code>                                                                                                                                                                                                                                                                                   |
| ingressClassResource.default            |                                                                                                                                                                                                                                                                                                              | <code>false</code>                                                                                                                                                                                                                                                                                        |
| ingressClassResource.controllerValue    |                                                                                                                                                                                                                                                                                                              | <code>getambassador.io/ingress-controller</code>                                                                                                                                                                                                                                                          |
| autoscaling                             | Enable autoscaling using HorizontalPodAutoscaler daemonSet: true, autoscaling will be disabled                                                                                                                                                                                                               | <code>{"behavior":{},"enabled":false,"maxReplicas":5,"metrics":[{"resource":{"name":"memory","target":{"averageUtilization":100,"type":"Utilization"}},"type":"Resource"},{"resource":{"name":"cpu","target":{"averageUtilization":300,"type":"Utilization"}},"type":"Resource"}],"minReplicas":2}</code> |
| namespace.name                          | Explicitly set the AMBASSADOR_NAMESPACE environment variable                                                                                                                                                                                                                                                 | <code></code>                                                                                                                                                                                                                                                                                             |
| security.podSecurityContext             | Security Context for all containers in the pod. https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/#podsecuritycontext-v1-core                                                                                                                                                              | <code>{"runAsUser":8888}</code>                                                                                                                                                                                                                                                                           |
| security.containerSecurityContext       | Security Context for the Ambassador container specifically https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/#securitycontext-v1-core                                                                                                                                                      | <code>{"allowPrivilegeEscalation":false}</code>                                                                                                                                                                                                                                                           |
| image.repository                        | Emissary Ingress docker repo                                                                                                                                                                                                                                                                                 | <code>docker.io/datawire/emissary</code>                                                                                                                                                                                                                                                                  |
| image.tag                               | Emissary Ingress docker tag                                                                                                                                                                                                                                                                                  | <code>3.12.2</code>                                                                                                                                                                                                                                                                                       |
| image.pullPolicy                        | Pod container image pull policy                                                                                                                                                                                                                                                                              | <code>IfNotPresent</code>                                                                                                                                                                                                                                                                                 |
| dnsPolicy                               | Dns policy, when hostNetwork set to ClusterFirstWithHostNet                                                                                                                                                                                                                                                  | <code>ClusterFirst</code>                                                                                                                                                                                                                                                                                 |
| hostNetwork                             | If true, uses the host network, useful for on-premise setups                                                                                                                                                                                                                                                 | <code>false</code>                                                                                                                                                                                                                                                                                        |
| service.type                            |                                                                                                                                                                                                                                                                                                              | <code>LoadBalancer</code>                                                                                                                                                                                                                                                                                 |
| service.portsRaw                        | For test purposes, do not use.                                                                                                                                                                                                                                                                               | <code>''</code>                                                                                                                                                                                                                                                                                           |
| service.externalTrafficPolicy           |                                                                                                                                                                                                                                                                                                              | <code></code>                                                                                                                                                                                                                                                                                             |
| service.sessionAffinity                 |                                                                                                                                                                                                                                                                                                              | <code></code>                                                                                                                                                                                                                                                                                             |
| service.sessionAffinityConfig           |                                                                                                                                                                                                                                                                                                              | <code></code>                                                                                                                                                                                                                                                                                             |
| service.nameOverride                    | Manually set the name of the generated Service                                                                                                                                                                                                                                                               | <code></code>                                                                                                                                                                                                                                                                                             |
| adminService.create                     | If true, create a service for Ambassador's admin UI                                                                                                                                                                                                                                                          | <code>true</code>                                                                                                                                                                                                                                                                                         |
| adminService.type                       | Ambassador's admin service type to be used                                                                                                                                                                                                                                                                   | <code>ClusterIP</code>                                                                                                                                                                                                                                                                                    |
| adminService.port                       |                                                                                                                                                                                                                                                                                                              | <code>8877</code>                                                                                                                                                                                                                                                                                         |
| adminService.snapshotPort               |                                                                                                                                                                                                                                                                                                              | <code>8005</code>                                                                                                                                                                                                                                                                                         |
| adminService.goPluginMetricsPort        |                                                                                                                                                                                                                                                                                                              | <code></code>                                                                                                                                                                                                                                                                                             |
| adminService.nodePort                   | If explicit NodePort for admin service is required                                                                                                                                                                                                                                                           | <code></code>                                                                                                                                                                                                                                                                                             |
| adminService.loadBalancerIP             | IP address to assign (if cloud provider supports it)                                                                                                                                                                                                                                                         | <code></code>                                                                                                                                                                                                                                                                                             |
| adminService.loadBalancerSourceRanges   | Passed to cloud provider load balancer if created (e.g: AWS ELB)                                                                                                                                                                                                                                             | <code></code>                                                                                                                                                                                                                                                                                             |
| rbac.create                             | Specifies whether RBAC resources should be created                                                                                                                                                                                                                                                           | <code>true</code>                                                                                                                                                                                                                                                                                         |
| rbac.nameOverride                       | Name of the RBAC resources defaults to the name of the release. Set nameOverride when installing Ambassador with cluster-wide scope in different namespaces with the same release name to avoid conflicts.                                                                                                   | <code></code>                                                                                                                                                                                                                                                                                             |
| scope.singleNamespace                   | Set the AMBASSADOR_SINGLE_NAMESPACE environment variable and create namespaced RBAC if rbac.enabled: true                                                                                                                                                                                                    | <code>false</code>                                                                                                                                                                                                                                                                                        |
| serviceAccount.create                   | Specifies whether a service account should be created                                                                                                                                                                                                                                                        | <code>true</code>                                                                                                                                                                                                                                                                                         |
| serviceAccount.name                     | The name of the service account to use. If not set and create is true, a name is generated using the fullname template                                                                                                                                                                                       | <code></code>                                                                                                                                                                                                                                                                                             |
| serviceAccount.extra                    | Extra YAML to include at the end of the ServiceAccount                                                                                                                                                                                                                                                       | <code>''</code>                                                                                                                                                                                                                                                                                           |
| deploymentStrategy.type                 |                                                                                                                                                                                                                                                                                                              | <code>RollingUpdate</code>                                                                                                                                                                                                                                                                                |
| progressDeadlines.ambassador            |                                                                                                                                                                                                                                                                                                              | <code>600</code>                                                                                                                                                                                                                                                                                          |
| progressDeadlines.agent                 |                                                                                                                                                                                                                                                                                                              | <code>600</code>                                                                                                                                                                                                                                                                                          |
| restartPolicy                           |                                                                                                                                                                                                                                                                                                              | <code></code>                                                                                                                                                                                                                                                                                             |
| terminationGracePeriodSeconds           |                                                                                                                                                                                                                                                                                                              | <code></code>                                                                                                                                                                                                                                                                                             |
| waitForApiext.enabled                   |                                                                                                                                                                                                                                                                                                              | <code>true</code>                                                                                                                                                                                                                                                                                         |
| waitForApiext.deploymentName            |                                                                                                                                                                                                                                                                                                              | <code>emissary-apiext</code>                                                                                                                                                                                                                                                                              |
| waitForApiext.deploymentNamespace       |                                                                                                                                                                                                                                                                                                              | <code>emissary-system</code>                                                                                                                                                                                                                                                                              |
| waitForApiext.securityContext.runAsUser |                                                                                                                                                                                                                                                                                                              | <code>8888</code>                                                                                                                                                                                                                                                                                         |
| waitForApiext.createRoles               |                                                                                                                                                                                                                                                                                                              | <code>true</code>                                                                                                                                                                                                                                                                                         |
| livenessProbe                           | Liveness probe for emissary pods                                                                                                                                                                                                                                                                             | <code>{"failureThreshold":3,"initialDelaySeconds":30,"periodSeconds":3}</code>                                                                                                                                                                                                                            |
| readinessProbe                          | Readiness probe for emissary pods                                                                                                                                                                                                                                                                            | <code>{"failureThreshold":3,"initialDelaySeconds":30,"periodSeconds":3}</code>                                                                                                                                                                                                                            |
| resources                               | CPU/memory resource requests/limits                                                                                                                                                                                                                                                                          | <code>{"limits":{"cpu":"1000m","memory":"600Mi"},"requests":{"cpu":"200m","memory":"300Mi"}}</code>                                                                                                                                                                                                       |
| priorityClassName                       | The name of the priorityClass for the ambassador DaemonSet/Deployment                                                                                                                                                                                                                                        | <code>''</code>                                                                                                                                                                                                                                                                                           |
| ambassadorConfig                        | Config thats mounted to `/ambassador/ambassador-config`                                                                                                                                                                                                                                                      | <code>''</code>                                                                                                                                                                                                                                                                                           |
| metrics.serviceMonitor.enabled          |                                                                                                                                                                                                                                                                                                              | <code>false</code>                                                                                                                                                                                                                                                                                        |
| resolvers                               | Resolvers are used to configure the discovery service strategy for Ambasador See: https://www.getambassador.io/docs/edge-stack/latest/topics/running/resolvers/ <br> Example: <br> `Configuration for a Consul Resolver` <br> `address: consul-server.default.svc.cluster.local:8500` <br> `datacenter: dc1` | <code>{"consul":{"create":false,"name":"consul-dc1","spec":{}},"endpoint":{"create":false,"name":"endpoint"}}</code>                                                                                                                                                                                      |
| module.diagnostics.enabled              |                                                                                                                                                                                                                                                                                                              | <code>false</code>                                                                                                                                                                                                                                                                                        |
| module.diagnostics.allow_non_local      |                                                                                                                                                                                                                                                                                                              | <code>true</code>                                                                                                                                                                                                                                                                                         |
| prometheusExporter                      | DEPRECATED: Enabling the prometheus exporter creates a sidecar and configures ambassador to use it Ambassador now exposes the /metrics endpoint in Envoy. See https://www.getambassador.io/user-guide/monitoring#deployment for more information on how to use the /metrics endpoint                         | <code>{"enabled":false,"pullPolicy":"IfNotPresent","repository":"prom/statsd-exporter","resources":{},"tag":"v0.8.1"}</code>                                                                                                                                                                              |
| agent.enabled                           | If `true`, installs the ambassador-agent Deployment, ServiceAccount and ClusterRole in the ambassador namespace, enabling the Ambassador Cloud connectivity.                                                                                                                                                 | <code>false</code>                                                                                                                                                                                                                                                                                        |
| agent.cloudConnectToken                 | API token for reporting snapshots to [Ambassador Cloud](https://app.getambassador.io/cloud/); If empty, agent will not report snapshots                                                                                                                                                                      | <code>''</code>                                                                                                                                                                                                                                                                                           |
| agent.rpcAddress                        | Address of the Ambassador Cloud rpc server.                                                                                                                                                                                                                                                                  | <code>https://app.getambassador.io/</code>                                                                                                                                                                                                                                                                |
| agent.reportDiagnostics                 | If `true`, Ambassador Agent will report diagnostics to Ambassador Cloud                                                                                                                                                                                                                                      | <code>true</code>                                                                                                                                                                                                                                                                                         |
| agent.createArgoRBAC                    |                                                                                                                                                                                                                                                                                                              | <code>true</code>                                                                                                                                                                                                                                                                                         |
| agent.image.tag                         | Leave blank to use image.repository and image.tag                                                                                                                                                                                                                                                            | <code>1.0.14</code>                                                                                                                                                                                                                                                                                       |
| agent.image.repository                  |                                                                                                                                                                                                                                                                                                              | <code>docker.io/ambassador/ambassador-agent</code>                                                                                                                                                                                                                                                        |
| agent.image.pullPolicy                  |                                                                                                                                                                                                                                                                                                              | <code>IfNotPresent</code>                                                                                                                                                                                                                                                                                 |
| deploymentTool                          |                                                                                                                                                                                                                                                                                                              | <code>''</code>                                                                                                                                                                                                                                                                                           |
| createNamespace                         |                                                                                                                                                                                                                                                                                                              | <code>false</code>                                                                                                                                                                                                                                                                                        |
| createDefaultListeners                  | Whether Emissary should be created with default listeners: - HTTP on port 8080 - HTTPS on port 8443                                                                                                                                                                                                          | <code>false</code>                                                                                                                                                                                                                                                                                        |
| lifecycle                               | Configure a 'lifecycle' section for the main pod                                                                                                                                                                                                                                                             | <code></code>                                                                                                                                                                                                                                                                                             |


Specify each parameter using the `--set key=value[,key=value]` argument to `helm install`. For example:

```console
$ helm install emissary-ingress --devel emissary-ingress/emissary-ingress -n ambassador --version=8.12.2 --set nameOverride=''
```

Alternatively, a YAML file that specifies the values for the parameters can be provided while
installing the chart. For example:

```console
$ helm install emissary-ingress --devel emissary-ingress/emissary-ingress -n ambassador --version=8.12.2 --values values.yaml
```
